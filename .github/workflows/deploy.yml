name: Deploy to Render

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Check Python syntax - Core files
        run: |
          python -m py_compile app.py
          python -m py_compile agent.py
          python -m py_compile agent_worker.py
          python -m py_compile worker_manager.py
          python -m py_compile supabase_client.py
          python -m py_compile document_processor.py
          python -m py_compile fsm.py
          python -m py_compile prompts.py

      - name: Validate requirements.txt
        run: |
          pip check

      - name: Verify critical files exist
        run: |
          test -f app.py || exit 1
          test -f agent_worker.py || exit 1
          test -f worker_manager.py || exit 1
          test -f supabase_client.py || exit 1
          test -d templates || exit 1
          test -f templates/form.html || exit 1
          test -f templates/interview.html || exit 1
          test -f templates/feedback.html || exit 1

  deploy:
    name: Deploy to Render
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Trigger Render Deploy
        run: |
          echo "All tests passed"
          echo "Deployment triggered by push to main branch"
          echo "Render will auto-deploy via webhook"
          echo ""
          echo "IMPORTANT: Ensure these environment variables are set in Render Dashboard:"
          echo "   - SUPABASE_URL (from Supabase project settings)"
          echo "   - SUPABASE_SERVICE_KEY (from Supabase project API settings)"
          echo "   - SUPABASE_ANON_KEY (from Supabase project API settings)"
          echo "   - ENCRYPTION_KEY (generate with: python -c 'from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())')"
          echo "   - SECRET_KEY (generate with: python -c 'import secrets; print(secrets.token_hex(32))')"
          echo "   - GOOGLE_CLIENT_ID (from Google Cloud Console OAuth credentials)"
          echo "   - GOOGLE_CLIENT_SECRET (from Google Cloud Console OAuth credentials)"
          echo ""
          echo "â„¹NOTE: LiveKit, OpenAI, and Deepgram API keys are NOT needed in environment"
          echo "   (BYOK model - users provide their own keys via Settings page)"
          echo ""
          echo "Visit your Render dashboard to monitor deployment progress"
