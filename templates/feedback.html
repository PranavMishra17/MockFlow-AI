<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interview Feedback - MockFlow-AI</title>
    <link rel="icon" href="/favicon.ico">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/styles.css">
    <link rel="stylesheet" href="/static/feedback.css">
</head>
<body>
    <div class="feedback-page">
        <div class="page-header">
            <h1>Interview Feedback</h1>
            <a href="/past-calls" class="back-link">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
                Back to Interviews
            </a>
        </div>

        <div class="loading-state" id="loadingState">Loading interview...</div>
        <div class="error-state" id="errorState" style="display: none;"></div>

        <div id="mainContent" style="display: none;">
            <div class="interview-info" id="interviewInfo"></div>

            <!-- Feedback Section -->
            <div class="feedback-section" id="feedbackSection">
                <div class="feedback-header">
                    <h2>AI-Powered Feedback</h2>
                    <button class="btn-generate-feedback" id="generateFeedbackBtn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/>
                        </svg>
                        Generate Feedback
                    </button>
                </div>
                
                <!-- Feedback loading state -->
                <div class="feedback-loading" id="feedbackLoading" style="display: none;">
                    <div class="feedback-spinner"></div>
                    <p>Analyzing your interview with AI...</p>
                    <p class="feedback-loading-sub">This may take a moment</p>
                </div>
                
                <!-- Feedback content -->
                <div class="feedback-content" id="feedbackContent" style="display: none;"></div>
                
                <!-- Feedback placeholder -->
                <div class="feedback-placeholder" id="feedbackPlaceholder">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="12" y1="16" x2="12" y2="12"/>
                        <line x1="12" y1="8" x2="12.01" y2="8"/>
                    </svg>
                    <p>Click "Generate Feedback" to get AI-powered analysis of your interview performance.</p>
                </div>
            </div>

            <div class="transcript-section">
                <div class="transcript-header">
                    <h2>Interview Transcript</h2>
                    <span id="turnCount"></span>
                </div>
                <div class="transcript-content" id="transcriptContent"></div>
            </div>
        </div>
    </div>

    <script>
    (function() {
        'use strict';
        
        var filename = '{{ filename }}';
        var feedbackGenerated = false;
        
        var elements = {
            loadingState: document.getElementById('loadingState'),
            errorState: document.getElementById('errorState'),
            mainContent: document.getElementById('mainContent'),
            interviewInfo: document.getElementById('interviewInfo'),
            transcriptContent: document.getElementById('transcriptContent'),
            turnCount: document.getElementById('turnCount'),
            generateFeedbackBtn: document.getElementById('generateFeedbackBtn'),
            feedbackLoading: document.getElementById('feedbackLoading'),
            feedbackContent: document.getElementById('feedbackContent'),
            feedbackPlaceholder: document.getElementById('feedbackPlaceholder')
        };
        
        document.addEventListener('DOMContentLoaded', init);
        
        function init() {
            loadInterview();
            elements.generateFeedbackBtn.addEventListener('click', requestFeedback);
        }
        
        function loadInterview() {
            fetch('/api/interview/' + encodeURIComponent(filename))
                .then(function(response) {
                    if (!response.ok) {
                        throw new Error('Interview not found');
                    }
                    return response.json();
                })
                .then(function(data) {
                    elements.loadingState.style.display = 'none';
                    
                    if (data.error) {
                        showError(data.error);
                        return;
                    }
                    
                    renderInterview(data);
                })
                .catch(function(err) {
                    console.error('[FEEDBACK] Load error:', err);
                    showError('Failed to load interview: ' + err.message);
                });
        }
        
        function showError(message) {
            elements.loadingState.style.display = 'none';
            elements.errorState.textContent = message;
            elements.errorState.style.display = 'block';
        }
        
        function renderInterview(data) {
            elements.mainContent.style.display = 'block';
            
            var meta = data.meta || {};
            var conversation = data.ordered_conversation || [];
            
            var stagesHtml = '';
            if (meta.stages_covered && meta.stages_covered.length) {
                stagesHtml = meta.stages_covered
                    .filter(function(s) { return s; })
                    .map(function(s) {
                        return '<span class="stage-badge">' + formatStage(s) + '</span>';
                    }).join('');
            }
            
            elements.interviewInfo.innerHTML = 
                '<div class="interview-info-grid">' +
                    '<div class="info-item">' +
                        '<span class="info-label">Candidate</span>' +
                        '<span class="info-value">' + escapeHtml(meta.candidate || 'Unknown') + '</span>' +
                    '</div>' +
                    '<div class="info-item">' +
                        '<span class="info-label">Date</span>' +
                        '<span class="info-value">' + formatDate(meta.interview_date) + '</span>' +
                    '</div>' +
                    '<div class="info-item">' +
                        '<span class="info-label">Total Turns</span>' +
                        '<span class="info-value">' + conversation.length + '</span>' +
                    '</div>' +
                    (stagesHtml ? 
                        '<div class="info-item">' +
                            '<span class="info-label">Stages</span>' +
                            '<div class="stages-list">' + stagesHtml + '</div>' +
                        '</div>' : '') +
                '</div>';
            
            elements.turnCount.textContent = conversation.length + ' turns';
            
            var transcriptHtml = conversation.map(function(turn) {
                var roleClass = turn.role === 'agent' ? 'agent' : 'candidate';
                var roleLabel = turn.role === 'agent' ? 'Interviewer' : 'Candidate';
                var stageTag = turn.stage ? '<span class="turn-stage">' + formatStage(turn.stage) + '</span>' : '';
                
                return '<div class="transcript-turn">' +
                    '<div class="turn-header">' +
                        '<span class="turn-role ' + roleClass + '">' + roleLabel + '</span>' +
                        stageTag +
                    '</div>' +
                    '<p class="turn-text">' + escapeHtml(turn.text) + '</p>' +
                '</div>';
            }).join('');
            
            elements.transcriptContent.innerHTML = transcriptHtml || '<p style="color: var(--text-light);">No transcript available.</p>';
            
            // Auto-generate feedback if requested via URL param
            var urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('request_feedback') === '1' && !feedbackGenerated) {
                requestFeedback();
            }
        }
        
        function requestFeedback() {
            if (feedbackGenerated) {
                return;
            }
            
            // Show loading state
            elements.generateFeedbackBtn.disabled = true;
            elements.generateFeedbackBtn.textContent = 'Generating...';
            elements.feedbackPlaceholder.style.display = 'none';
            elements.feedbackLoading.style.display = 'flex';
            elements.feedbackContent.style.display = 'none';
            
            fetch('/api/feedback', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ interview_id: filename })
            })
            .then(function(response) { return response.json(); })
            .then(function(data) {
                elements.feedbackLoading.style.display = 'none';
                
                if (data.error) {
                    showFeedbackError(data.error + ': ' + (data.message || ''));
                    return;
                }
                
                feedbackGenerated = true;
                renderFeedback(data.feedback);
            })
            .catch(function(err) {
                console.error('[FEEDBACK] Request error:', err);
                elements.feedbackLoading.style.display = 'none';
                showFeedbackError('Failed to generate feedback: ' + err.message);
            });
        }
        
        function showFeedbackError(message) {
            elements.feedbackContent.style.display = 'block';
            elements.feedbackContent.innerHTML = 
                '<div class="feedback-error">' +
                    '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">' +
                        '<circle cx="12" cy="12" r="10"/>' +
                        '<line x1="15" y1="9" x2="9" y2="15"/>' +
                        '<line x1="9" y1="9" x2="15" y2="15"/>' +
                    '</svg>' +
                    '<p>' + escapeHtml(message) + '</p>' +
                    '<button class="btn-retry" onclick="location.reload()">Retry</button>' +
                '</div>';
            elements.generateFeedbackBtn.disabled = false;
            elements.generateFeedbackBtn.innerHTML = 
                '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">' +
                    '<path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/>' +
                '</svg>' +
                'Retry Feedback';
        }
        
        function renderFeedback(feedbackText) {
            elements.feedbackContent.style.display = 'block';
            elements.generateFeedbackBtn.style.display = 'none';
            
            // Convert markdown-like text to HTML
            var html = formatFeedbackText(feedbackText);
            
            elements.feedbackContent.innerHTML = 
                '<div class="feedback-success">' +
                    '<div class="feedback-text">' + html + '</div>' +
                '</div>';
        }
        
        function formatFeedbackText(text) {
            if (!text) return '<p>No feedback available.</p>';
            
            // Split into sections by numbered headers
            var lines = text.split('\n');
            var html = '';
            var inList = false;
            
            for (var i = 0; i < lines.length; i++) {
                var line = lines[i].trim();
                
                if (!line) {
                    if (inList) {
                        html += '</ul>';
                        inList = false;
                    }
                    continue;
                }
                
                // Check for section headers (1. 2. 3. etc)
                var headerMatch = line.match(/^(\d+)\.\s*(.+)$/);
                if (headerMatch) {
                    if (inList) {
                        html += '</ul>';
                        inList = false;
                    }
                    html += '<h3 class="feedback-section-title">' + escapeHtml(headerMatch[2]) + '</h3>';
                    continue;
                }
                
                // Check for bullet points
                if (line.startsWith('-') || line.startsWith('*') || line.startsWith('â€¢')) {
                    if (!inList) {
                        html += '<ul class="feedback-list">';
                        inList = true;
                    }
                    var bulletContent = line.substring(1).trim();
                    // Bold text between ** **
                    bulletContent = bulletContent.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
                    html += '<li>' + escapeHtml(bulletContent).replace(/&lt;strong&gt;/g, '<strong>').replace(/&lt;\/strong&gt;/g, '</strong>') + '</li>';
                    continue;
                }
                
                // Regular paragraph
                if (inList) {
                    html += '</ul>';
                    inList = false;
                }
                
                // Bold text between ** **
                var formattedLine = line.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
                html += '<p>' + escapeHtml(formattedLine).replace(/&lt;strong&gt;/g, '<strong>').replace(/&lt;\/strong&gt;/g, '</strong>') + '</p>';
            }
            
            if (inList) {
                html += '</ul>';
            }
            
            return html;
        }
        
        function formatDate(isoDate) {
            if (!isoDate) return 'Unknown';
            try {
                var date = new Date(isoDate);
                return date.toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (e) {
                return isoDate;
            }
        }
        
        function formatStage(stage) {
            if (!stage) return '';
            var map = {
                'welcome': 'Welcome',
                'self_intro': 'Introduction',
                'past_experience': 'Experience',
                'company_fit': 'Company Fit',
                'closing': 'Closing'
            };
            return map[stage] || stage;
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            var div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    })();
    </script>
</body>
</html>
